<section class="product-recommendations bg-background py-20">
  <div class="max-w-container mx-auto px-4 lg:px-8">
    <h2 class="font-display font-bold text-3xl text-text text-center mb-12">
      {%- if section.settings.heading != blank -%}
        {{ section.settings.heading }}
      {%- else -%}
        You may also like
      {%- endif -%}
    </h2>
    
    <div class="recommended-products-wrapper" id="product-recommendations" data-product-id="{{ product.id }}">
      {%- comment -%}
        Placeholder for when recommendations are loading
      {%- endcomment -%}
      <div class="loading-recommendations text-center py-8">
        <div class="animate-pulse">
          <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
            {%- for i in (1..section.settings.products_to_show) -%}
              <div class="bg-accent rounded-sloe-card h-64"></div>
            {%- endfor -%}
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const productRecommendations = document.getElementById('product-recommendations');
    const productId = productRecommendations.dataset.productId;
    const productsToShow = {{ section.settings.products_to_show }};
    
    fetch(`/recommendations/products?section_id={{ section.id }}&product_id=${productId}&limit=${productsToShow}`)
      .then(response => response.text())
      .then(text => {
        const html = text;
        productRecommendations.innerHTML = html;
      })
      .catch(error => {
        console.error('Error loading product recommendations:', error);
        productRecommendations.innerHTML = '<p class="text-center text-text opacity-70">Unable to load recommendations</p>';
      });
  });
</script>

{%- if recommendations.performed and recommendations.products_count > 0 -%}
  <div class="recommended-products grid grid-cols-2 md:grid-cols-4 gap-6">
    {%- for recommended_product in recommendations.products limit: section.settings.products_to_show -%}
      <div class="recommended-product">
        <div class="product-card bg-white rounded-sloe-card shadow-lg overflow-hidden hover:shadow-xl transition-shadow">
          <a href="{{ recommended_product.url }}" class="product-link">
            {%- if recommended_product.featured_image -%}
              <div class="product-image-wrapper relative">
                <img
                  src="{{ recommended_product.featured_image | image_url: width: 300 }}"
                  alt="{{ recommended_product.featured_image.alt | escape }}"
                  loading="lazy"
                  class="product-image w-full h-48 object-cover"
                  width="300"
                  height="300"
                >
                
                {%- if recommended_product.compare_at_price > recommended_product.price -%}
                  <div class="product-badge absolute top-2 left-2 bg-primary text-white px-2 py-1 text-xs rounded">
                    Sale
                  </div>
                {%- endif -%}
              </div>
            {%- endif -%}
            
            <div class="product-info p-4">
              <h3 class="product-title font-display font-semibold text-lg text-text mb-2 line-clamp-2">
                {{ recommended_product.title }}
              </h3>
              
              <div class="product-price">
                <span class="price font-bold text-primary">{{ recommended_product.price | money }}</span>
                {%- if recommended_product.compare_at_price > recommended_product.price -%}
                  <span class="compare-price text-sm text-text opacity-50 line-through ml-2">{{ recommended_product.compare_at_price | money }}</span>
                {%- endif -%}
              </div>
            </div>
          </a>
        </div>
      </div>
    {%- endfor -%}
  </div>
{%- endif -%}

<style>
  .line-clamp-2 {
    overflow: hidden;
    display: -webkit-box;
    -webkit-box-orient: vertical;
    -webkit-line-clamp: 2;
  }
  
  .animate-pulse {
    animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
  }
  
  @keyframes pulse {
    0%, 100% {
      opacity: 1;
    }
    50% {
      opacity: .5;
    }
  }
</style>

{% schema %}
{
  "name": "Product recommendations",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "You may also like"
    },
    {
      "type": "range",
      "id": "products_to_show",
      "min": 2,
      "max": 10,
      "step": 1,
      "default": 4,
      "label": "Products to show"
    }
  ]
}
{% endschema %}